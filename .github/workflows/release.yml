name: Release

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - master
  workflow_dispatch:
    inputs:
      tag:
        description: "Semantic version tag (e.g., v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

env:
  GO_VERSION: "1.21.x"
  DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

jobs:
  build-and-release:
    name: Build and publish release
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: vars
        shell: pwsh
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $tag = "${{ inputs.tag }}"
          } else {
            $tag = "${{ github.ref_name }}"
          }

          if (-not $tag) {
            Write-Error "Tag value is required."
            exit 1
          }

          if (-not ($tag -match '^v\d+\.\d+\.\d+$')) {
            Write-Error "Tag must match semantic version format vX.Y.Z"
            exit 1
          }

          "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Ensure tag commit is on main
        shell: pwsh
        run: |
          $defaultBranch = "${{ env.DEFAULT_BRANCH }}"
          if ([string]::IsNullOrWhiteSpace($defaultBranch)) {
            $defaultBranch = "main"
          }

          git fetch origin $defaultBranch --depth=1
          git merge-base --is-ancestor $env:GITHUB_SHA origin/$defaultBranch
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Tag commit must be on branch '$defaultBranch'."
            exit 1
          }

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build Windows binary
        run: go build -ldflags="-s -w -H windowsgui" -o dist/llt-helper.exe ./cmd/llt-helper

      - name: Prepare release assets
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path release/assets/icons -Force | Out-Null
          Copy-Item dist/llt-helper.exe release/
          Get-ChildItem assets/icons -Recurse -File -Include *.png,*.svg | Copy-Item -Destination release/assets/icons/
          Compress-Archive -Path release/* -DestinationPath streamdock-llt-helper_windows.zip -Force

      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: |
            dist/llt-helper.exe
            streamdock-llt-helper_windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

